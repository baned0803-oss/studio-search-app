<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ãƒ¬ãƒ³ã‚¿ãƒ«ã‚¹ã‚¿ã‚¸ã‚ªæ¯”è¼ƒï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼‰</title>
    <style>
        body {
            font-family: 'Inter', Arial, Helvetica, sans-serif;
            margin: 20px;
            background-color: #f4f7f9;
        }
        h1 {
            font-size: 28px;
            margin-bottom: 24px;
            color: #333;
            border-bottom: 2px solid #0b84ff;
            padding-bottom: 8px;
        }
        .controls {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 30px;
            align-items: center;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .controls label {
            font-size: 14px;
            color: #555;
            font-weight: 600;
        }
        input[type="time"], input[type="number"] {
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            transition: border-color 0.3s;
            min-width: 120px;
        }
        input[type="time"]:focus, input[type="number"]:focus {
            border-color: #0b84ff;
            outline: none;
        }
        .card {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.08);
        }
        .card h3 {
            margin: 0 0 8px 0;
            font-size: 20px;
            color: #1a1a1a;
        }
        .meta {
            color: #555;
            font-size: 14px;
        }
        .meta p {
            margin: 4px 0;
        }
        .meta strong {
            color: #0b84ff;
        }
        button {
            background: #0b84ff;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s, transform 0.1s;
        }
        button:hover {
            background: #0066cc;
        }
        button:active {
            transform: scale(0.98);
        }
        #result {
            padding: 10px 0;
        }

        @media(max-width:768px){
            .controls{
                flex-direction: column;
                align-items: stretch;
            }
            .controls > div {
                display: flex;
                flex-direction: column;
            }
            input[type="time"], input[type="number"] {
                min-width: 100%;
                box-sizing: border-box;
            }
            button {
                width: 100%;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <h1>ãƒ¬ãƒ³ã‚¿ãƒ«ã‚¹ã‚¿ã‚¸ã‚ªæ¯”è¼ƒï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼‰</h1>
    <div class="controls">
        <div>
            <label>æ™‚é–“ (å¸Œæœ›é–‹å§‹æ™‚é–“): <input id="timeInput" type="time" /></label>
        </div>
        <div>
            <label>æœ€å¤§ä¾¡æ ¼(å††): <input id="priceInput" type="number" min="0" step="100" /></label>
        </div>
        <div>
            <label>æœ€å°äººæ•°: <input id="peopleInput" type="number" min="1" step="1" /></label>
        </div>
        <div>
            <button id="searchBtn">æ¤œç´¢</button>
        </div>
    </div>
    <div id="result"></div>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

    <script>
        // ---------Â è¨­å®š: AirtableÂ å…¬é–‹ãƒ“ãƒ¥ãƒ¼ã®Â CSV URLÂ ã‚’ã“ã“ã«å…¥ã‚Œã¦ãã ã•ã„Â ----------
        // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€ãŸã‚ã€URLã¯ç©ºæ¬„ã«ã—ã¾ã™
        const AIRTABLE_CSV_URL = ''; 
        
        // localStorageã‚­ãƒ¼
        const LSKEY = 'studio_search_conditions_v1';

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼: "HH:MM" => minutes
        function toMinutes(hhmm){
            if(!hhmm) return null;
            const [h,m] = hhmm.split(':').map(Number);
            return h*60 + m;
        }

        // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆç°¡æ˜“ï¼‰
        function escapeHtml(s){ return String(s || '').replace(/&/g,'&').replace(/</g,'<').replace(/>/g,'>'); }
        function escapeAttr(s){ return String(s || '').replace(/"/g,'"'); }

        // è¦ç´ å–å¾—
        const timeInput = document.getElementById('timeInput');
        const priceInput = document.getElementById('priceInput');
        const peopleInput = document.getElementById('peopleInput');
        const searchBtn = document.getElementById('searchBtn');
        const result = document.getElementById('result');

        // åˆæœŸå€¤å¾©å…ƒ
        const saved = JSON.parse(localStorage.getItem(LSKEY) || '{}');
        if(saved.time) timeInput.value = saved.time;
        if(saved.price) priceInput.value = saved.price;
        if(saved.people) peopleInput.value = saved.people;

        // ãƒ¬ãƒ³ã‚¿ãƒªãƒ³ã‚°
        function renderCards(items){
            result.innerHTML = '';
            if(items.length === 0){
                result.innerHTML = '<p>è©²å½“ã™ã‚‹ã‚¹ã‚¿ã‚¸ã‚ªã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
                return;
            }
            items.forEach(it=>{
                // ãƒ‡ãƒ¼ã‚¿æ¬ ææ™‚ã®å®‰å…¨ãƒã‚§ãƒƒã‚¯
                if (!it.rate || !it.room) return; 
                
                const div = document.createElement('div');
                div.className = 'card';
                
                div.innerHTML = '<h3>' + escapeHtml(it.studio_name) + ' - ' + escapeHtml(it.room_name) + '</h3>' +
                    '<div class="meta">æ–™é‡‘: ' + (it.rate.min_price ?? '-') + 'å††Â ('+ escapeHtml(it.rate.rate_name || '') +')' +
                    ' /Â æ¨å¥¨æœ€å¤§: ' + (it.room.recommended_max ?? '-') + 'äºº' +
                    // cost_per_person ã¯ã“ã“ã§å­˜åœ¨ãŒä¿è¨¼ã•ã‚Œã‚‹
                    ' / 1äººã‚ãŸã‚Š: ' + (it.cost_per_person ? Math.round(it.cost_per_person) + 'å††' : '-') +
                    '</div>' +
                    '<p style="margin-top:8px;"><a href="'+escapeAttr(it.studio_url || '#')+'" target="_blank"><button>ã“ã®éƒ¨å±‹ã‚’äºˆç´„ã™ã‚‹</button></a></p>';
                result.appendChild(div);
            });
        }

        // æ¤œç´¢å‡¦ç†
        function runSearch(studios){
            function search(){
                const st = timeInput.value;
                const maxPrice = priceInput.value ? Number(priceInput.value) : Infinity;
                const minPeople = peopleInput.value ? Number(peopleInput.value) : 0;
                localStorage.setItem(LSKEY, JSON.stringify({time:st, price: priceInput.value, people: peopleInput.value}));
                const tmin = toMinutes(st);
                const results = [];

                studios.forEach(studio=>{
                    (studio.rooms || []).forEach(room=>{
                        (room.rates || []).forEach(rate=>{
                            const s = toMinutes(rate.start_time);
                            const e = toMinutes(rate.end_time);
                            
                            // æ¤œç´¢æ¡ä»¶ãƒã‚§ãƒƒã‚¯
                            if(tmin === null) return;
                            if(!(s <= tmin && tmin < e)) return;
                            if(rate.min_price != null && rate.min_price > maxPrice) return;
                            if(room.recommended_max != null && room.recommended_max < minPeople) return;
                            
                            // ğŸš¨ Cost Per Person ã®è¨ˆç®—ã‚’ã“ã“ã§è¡Œã„ã€ã‚¼ãƒ­é™¤ç®—ã‚’ç¢ºå®Ÿã«é˜²ã
                            const isCalculable = rate.min_price != null && room.recommended_max != null && room.recommended_max > 0;
                            const cost_per_person = isCalculable ? rate.min_price / room.recommended_max : null;
                            
                            results.push({
                                studio_name: studio.studio_name,
                                studio_url: studio.official_url,
                                room_name: room.room_name,
                                room: room,
                                rate: rate,
                                cost_per_person: cost_per_person // ã“ã“ã§å€¤ãŒç¢ºå®šã™ã‚‹
                            });
                        });
                    });
                });

                // ã‚³ã‚¹ãƒˆ per person ã§ã‚½ãƒ¼ãƒˆï¼ˆnullã¯æœ€å¾Œã«å›ã‚‹ï¼‰
                results.sort((a,b)=>(a.cost_per_person ?? Infinity) - (b.cost_per_person ?? Infinity));
                renderCards(results);
            }

            searchBtn.addEventListener('click', search);
            [timeInput, priceInput, peopleInput].forEach(inp=>{
                inp.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') search(); });
            });
            // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å¾Œã«åˆæœŸæ¤œç´¢ã‚’å®Ÿè¡Œ
            search();
        }


        // ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼šä¾¡æ ¼ã‹ã‚‰ã€Œå††ã€ã¨æ—¥ä»˜ã‚’å‰Šé™¤ã—ã€ã‚¯ãƒªãƒ¼ãƒ³ãªãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™é–¢æ•°
        function cleanRateData(r) {
            // min_priceã‹ã‚‰ã€Œå††ã€ã¨æ•°å­—ä»¥å¤–ã®æ–‡å­—ã‚’å‰Šé™¤ã—ã¦æ•°å€¤åŒ–
            let price = (r.min_price || '').toString().replace(/[^\d.]/g, '');
            price = price ? Number(price) : null;
            
            // start_time / end_time ã‹ã‚‰æ™‚åˆ»éƒ¨åˆ†ï¼ˆHH:MMï¼‰ã ã‘ã‚’æŠ½å‡º (ä¾‹: "2025/11/4 10:00" -> "10:00")
            const startTimeMatch = (r.start_time || '').match(/(\d{2}:\d{2})$/);
            const endTimeMatch = (r.end_time || '').match(/(\d{2}:\d{2})$/);

            return {
                rate_name: (r.rate_name||'').trim(),
                // ä¿®æ­£å¾Œã®æ™‚åˆ»ã‚’é©ç”¨
                start_time: startTimeMatch ? startTimeMatch[1] : (r.start_time||'').trim(), 
                end_time: endTimeMatch ? endTimeMatch[1] : (r.end_time||'').trim(),
                // ä¿®æ­£å¾Œã®ä¾¡æ ¼ã‚’é©ç”¨
                min_price: price 
            };
        }

        // CSVã‚’å–å¾—ã—ã¦è§£æ (ä»Šå›ã¯å®Ÿè¡Œã•ã‚Œãªã„)
        async function fetchCsvToStudios(url){
             const res = await fetch(url);
             if(!res.ok) throw new Error('CSV fetch failed: '+res.status);
             const text = await res.text();
             const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
             const rows = parsed.data; 
             // CSVã®å ´åˆã‚‚cleanRateDataã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚’çµ±ä¸€
             return processFetchedData(rows);
        }

        // data.json ã‹ã‚‰èª­ã¿è¾¼ã‚€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ (âœ¨ ä»Šå›ã¯ã“ã‚ŒãŒå®Ÿè¡Œã•ã‚Œã‚‹)
        async function fetchLocalJson(){
            const res = await fetch('data.json');
            // JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã™
            if(!res.ok) throw new Error('data.json fetch failed: '+res.status + ' - JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ãƒ‘ã‚¹ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚');
            const data = await res.json();
            
            // JSONã®é…åˆ—ã‚’CSVã¨åŒã˜å‡¦ç†ã§æ§‹é€ åŒ–ã™ã‚‹
            return processFetchedData(data);
        }

        // ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ (CSV/JSONå…±é€š)
        function processFetchedData(rows) {
            const studiosMap = {};
            rows.forEach(r=>{
                 // studio_id, room_id, recommended_max, official_url ã¯JSONãƒ‡ãƒ¼ã‚¿ã«ä¾å­˜
                 const sid = (r.studio_id || r.studio_name || '').toString().trim();
                 if(!sid) return;

                 if(!studiosMap[sid]) {
                     studiosMap[sid] = { 
                         id: sid, 
                         studio_name: (r.studio_name||'').trim(), 
                         official_url: (r.official_url||'').trim(), 
                         rooms: {} 
                     };
                 }
                 const s = studiosMap[sid];

                 const rid = (r.room_id || r.room_name || '').toString().trim();
                 if(!rid) return;
                 
                 if(!s.rooms[rid]) {
                     s.rooms[rid] = { 
                         id: rid, 
                         room_name: (r.room_name||'').trim(), 
                         recommended_max: r.recommended_max ? Number(r.recommended_max) : null, 
                         rates: [] 
                     };
                 }
                 
                 // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã§ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                 const rate = cleanRateData(r);

                 if(rate.rate_name && rate.start_time && rate.min_price !== null) {
                      s.rooms[rid].rates.push(rate);
                 }
            });

            return Object.values(studiosMap).map(s=>({ id: s.id, studio_name: s.studio_name, official_url: s.official_url, rooms: Object.values(s.rooms) }));
        }


        // ==========================================================
        // ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼šéåŒæœŸã®åˆæœŸåŒ–é–¢æ•°ã«ãƒ©ãƒƒãƒ—ã—ã€å®Ÿè¡Œã™ã‚‹ 
        // ==========================================================
        async function initializeApp(){
            try{
                let studios;
                // åˆæœŸå€¤è¨­å®š 
                if (!timeInput.value) { timeInput.value = '18:00'; }
                if (!priceInput.value) { priceInput.value = '5000'; }
                if (!peopleInput.value) { peopleInput.value = '5'; }
                
                if(AIRTABLE_CSV_URL && AIRTABLE_CSV_URL.trim() !== ''){
                    console.log('Airtable CSVã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’é–‹å§‹ã—ã¾ã™...');
                    studios = await fetchCsvToStudios(AIRTABLE_CSV_URL);
                    
                } else {
                    console.log('AIRTABLE_CSV_URLãŒæœªè¨­å®šã®ãŸã‚ã€data.jsonã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚');
                    studios = await fetchLocalJson();
                }
                
                // ğŸ’¡ ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºã™ã‚‹ (ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’è§£é™¤)
                console.log('--- èª­ã¿è¾¼ã¾ã‚ŒãŸæœ€çµ‚ãƒ‡ãƒ¼ã‚¿ ---');
                console.log(studios); 
                
                // åˆæœŸåŒ–å®Œäº†å¾Œã«æ¤œç´¢ã‚’ãƒã‚¤ãƒ³ãƒ‰
                runSearch(studios);
                
            }catch(err){
                console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', err);
                result.innerHTML = '<p style="color:red;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ« (F12) ã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
            }
        }

        // ãƒšãƒ¼ã‚¸ãŒå®Œå…¨ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚‰éåŒæœŸã®åˆæœŸåŒ–é–¢æ•°ã‚’å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>