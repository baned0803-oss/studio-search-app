<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ãƒ¬ãƒ³ã‚¿ãƒ«ã‚¹ã‚¿ã‚¸ã‚ªæ¯”è¼ƒï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼‰</title>
    <style>
    /* ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
    body {
        font-family: 'Inter', 'Noto Sans JP', Arial, Helvetica, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f8f9fa; /* èƒŒæ™¯ã‚’ãƒ©ã‚¤ãƒˆã‚°ãƒ¬ãƒ¼ã« */
        color: #333;
    }
    h1 {
        font-size: 26px;
        margin: 0 0 24px 0;
        color: #212529;
        border-bottom: 3px solid #007bff; /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ã®é’ */
        padding-bottom: 8px;
    }
    
    /* æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚³ãƒ³ãƒ†ãƒŠ */
    .controls {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        margin-bottom: 30px;
        align-items: flex-end; /* ãƒœã‚¿ãƒ³ã¨å…¥åŠ›æ¬„ã®ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚’æƒãˆã‚‹ */
        padding: 20px;
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* å½±ã‚’å¼·èª¿ */
    }
    .controls > div {
        display: flex;
        flex-direction: column;
        min-width: 150px; /* å…¥åŠ›æ¬„ã®æœ€å°å¹… */
    }
    .controls label {
        font-size: 14px;
        color: #555;
        font-weight: 500;
        margin-bottom: 5px;
    }
    input[type="time"], input[type="number"] {
        padding: 10px 12px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 16px;
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    input[type="time"]:focus, input[type="number"]:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        outline: none;
    }
    
    /* æ¤œç´¢ãƒœã‚¿ãƒ³ */
    button#searchBtn {
        background: #007bff;
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.3s, transform 0.1s;
        box-shadow: 0 2px 4px rgba(0, 123, 255, 0.4);
        height: 44px; /* å…¥åŠ›æ¬„ã¨é«˜ã•ã‚’åˆã‚ã›ã‚‹ */
    }
    button#searchBtn:hover {
        background: #0056b3;
    }
    button#searchBtn:active {
        transform: scale(0.98);
    }

    /* æ¤œç´¢çµæœã®ã‚³ãƒ³ãƒ†ãƒŠ */
    #result {
        padding: 10px 0;
    }
    #result > .summary {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 20px;
        padding-bottom: 5px;
        border-bottom: 1px solid #ddd;
        color: #007bff;
    }

    /* çµæœã‚«ãƒ¼ãƒ‰ã®ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º */
    .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    /* çµæœã‚«ãƒ¼ãƒ‰ */
    .card {
        padding: 20px;
        border-radius: 10px;
        background: #ffffff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    .card h3 {
        margin: 0 0 5px 0;
        font-size: 20px;
        color: #212529;
        line-height: 1.3;
    }
    .card .room-name {
        font-size: 16px;
        color: #555;
        margin-bottom: 15px;
        border-bottom: 1px dashed #eee;
        padding-bottom: 8px;
    }

    /* ãƒ¡ã‚¿æƒ…å ±ï¼ˆè©³ç´°ï¼‰ */
    .meta-item {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        margin-bottom: 8px;
        padding: 3px 0;
        border-bottom: 1px dotted #eee;
    }
    .meta-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    .meta-item strong {
        color: #212529;
        font-weight: 600;
    }
    
    /* 1äººã‚ãŸã‚Šè²»ç”¨ã‚’å¼·èª¿ */
    .cost-per-person {
        font-size: 24px;
        font-weight: 700;
        color: #dc3545; /* èµ¤è‰²ã§ç›®ç«‹ãŸã›ã‚‹ */
        background-color: #ffe8e8; /* è–„ã„èµ¤ã®èƒŒæ™¯ */
        padding: 10px;
        border-radius: 6px;
        margin: 15px 0;
        text-align: center;
        letter-spacing: 0.5px;
    }
    .cost-per-person.disabled {
        background-color:#f1f1f1; 
        color:#888;
        font-size: 18px;
        font-weight: 500;
    }

    /* äºˆç´„ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    .card a button {
        width: 100%;
        margin-top: 15px;
        background: #28a745; /* ç·‘è‰² (Success Color) */
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.4);
    }
    .card a button:hover {
        background: #1e7e34;
    }

    /* è©²å½“ãªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    #result > p:not(.summary) {
        grid-column: 1 / -1; /* ã‚°ãƒªãƒƒãƒ‰å…¨ä½“ã«åºƒã’ã‚‹ */
        text-align: center;
        color: #555;
        padding: 30px;
        background: #f1f1f1;
        border-radius: 8px;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ (ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ) */
    @media (max-width: 600px) {
        body {
            padding: 15px;
        }
        .controls {
            flex-direction: column;
            gap: 15px;
            padding: 15px;
        }
        .controls > div {
            min-width: 100%;
        }
        button#searchBtn {
            width: 100%;
            margin-top: 5px;
        }
    }
</style>
</head>
<body>
    <h1>ãƒ¬ãƒ³ã‚¿ãƒ«ã‚¹ã‚¿ã‚¸ã‚ªæ¯”è¼ƒï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼‰</h1>
    <div class="controls">
        <div>
            <label>æ™‚é–“ (å¸Œæœ›é–‹å§‹æ™‚é–“): <input id="timeInput" type="time" /></label>
        </div>
        <div>
            <label>æœ€å¤§ä¾¡æ ¼(å††): <input id="priceInput" type="number" min="0" step="100" /></label>
        </div>
        <div>
            <label>å¸Œæœ›äººæ•°: <input id="peopleInput" type="number" min="1" step="1" /></label>
        </div>
        <div>
            <button id="searchBtn">æ¤œç´¢</button>
        </div>
    </div>
    <div id="result"></div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

    <script>
        // ---------Â è¨­å®š: AirtableÂ å…¬é–‹ãƒ“ãƒ¥ãƒ¼ã®Â CSV URLÂ ã‚’ã“ã“ã«å…¥ã‚Œã¦ãã ã•ã„Â ----------
        // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€ãŸã‚ã€URLã¯ç©ºæ¬„ã«ã—ã¾ã™
        const AIRTABLE_CSV_URL = ''; 
        
        // localStorageã‚­ãƒ¼
        const LSKEY = 'studio_search_conditions_v2'; // v2ã«ã‚­ãƒ¼ã‚’å¤‰æ›´ã—ã¦ä¿å­˜æ¡ä»¶ã‚’ãƒªã‚»ãƒƒãƒˆ

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼: "HH:MM" => minutes
        function toMinutes(hhmm){
            if(!hhmm) return null;
            const [h,m] = hhmm.split(':').map(Number);
            return h*60 + m;
        }

        // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆç°¡æ˜“ï¼‰
        function escapeHtml(s){ return String(s || '').replace(/&/g,'&').replace(/</g,'<').replace(/>/g,'>'); }
        function escapeAttr(s){ return String(s || '').replace(/"/g,'"'); }

        // è¦ç´ å–å¾—
        const timeInput = document.getElementById('timeInput');
        const priceInput = document.getElementById('priceInput');
        const peopleInput = document.getElementById('peopleInput');
        const searchBtn = document.getElementById('searchBtn');
        const result = document.getElementById('result');

        // åˆæœŸå€¤å¾©å…ƒ
        const saved = JSON.parse(localStorage.getItem(LSKEY) || '{}');
        if(saved.time) timeInput.value = saved.time;
        if(saved.price) priceInput.value = saved.price;
        if(saved.people) peopleInput.value = saved.people;

        // ãƒ¬ãƒ³ã‚¿ãƒªãƒ³ã‚°
        function renderCards(items, requestedPeople){ // ğŸ’¡ å¸Œæœ›äººæ•°ã‚’å—ã‘å–ã‚‹
            result.innerHTML = '';
            if(items.length === 0){
                result.innerHTML = '<p>è©²å½“ã™ã‚‹ã‚¹ã‚¿ã‚¸ã‚ªã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
                return;
            }
            // æ¤œç´¢æ¦‚è¦ã‚’è¡¨ç¤º
            const summary = document.createElement('p');
            summary.innerHTML = `**${items.length}ä»¶**ã®ã‚¹ã‚¿ã‚¸ã‚ªãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚(å¸Œæœ›äººæ•° ${requestedPeople}åã§ã®è¨ˆç®—)`;
            summary.style.fontWeight = 'bold';
            summary.style.marginBottom = '20px';
            summary.style.padding = '10px 0';
            result.appendChild(summary);


            items.forEach(it=>{
                // ãƒ‡ãƒ¼ã‚¿æ¬ ææ™‚ã®å®‰å…¨ãƒã‚§ãƒƒã‚¯
                if (!it.rate || !it.room) return; 
                
                const div = document.createElement('div');
                div.className = 'card';
                
                // 1äººã‚ãŸã‚Šè²»ç”¨ã‚’è¨ˆç®—äººæ•°ã§è¡¨ç¤º
                const costHtml = it.cost_per_person
                    ? `<div class="cost-per-person">1äººã‚ãŸã‚Š ${Math.round(it.cost_per_person).toLocaleString()}å††</div>`
                    : '<div class="cost-per-person" style="background-color:#f8f9fa; color:#888;">è¨ˆç®—å¯¾è±¡å¤–</div>';
                
                div.innerHTML = `
                    <div>
                        <h3>${escapeHtml(it.studio_name)}</h3>
                        <div class="room-name">${escapeHtml(it.room_name)}</div>
                        
                        ${costHtml}

                        <div class="meta-item">
                            <span>åŸºæœ¬æ–™é‡‘ (${escapeHtml(it.rate.rate_name || '')}):</span>
                            <strong>${(it.rate.min_price ?? '-').toLocaleString()}å††</strong>
                        </div>
                        <div class="meta-item">
                            <span>éƒ¨å±‹ã®æ¨å¥¨æœ€å¤§äººæ•°:</span>
                            <strong>${(it.room.recommended_max ?? '-')}äºº</strong>
                        </div>
                        <div class="meta-item">
                            <span>æ¤œç´¢æ™‚ã®å¸Œæœ›äººæ•°:</span>
                            <strong>${requestedPeople}äºº</strong>
                        </div>
                    </div>
                    <p style="margin-top:10px;"><a href="${escapeAttr(it.studio_url || '#')}" target="_blank"><button>ã“ã®éƒ¨å±‹ã‚’äºˆç´„ã™ã‚‹</button></a></p>
                `;
                result.appendChild(div);
            });
        }

        // æ¤œç´¢å‡¦ç†
        function runSearch(studios){
            function search(){
                const st = timeInput.value;
                const maxPrice = priceInput.value ? Number(priceInput.value) : Infinity;
                const requestedPeople = peopleInput.value ? Number(peopleInput.value) : 0; // ğŸ’¡ å¸Œæœ›äººæ•°ã¨ã—ã¦å–å¾—
                
                // æ¤œç´¢æ¡ä»¶ã‚’ä¿å­˜
                localStorage.setItem(LSKEY, JSON.stringify({time:st, price: priceInput.value, people: peopleInput.value}));
                
                const tmin = toMinutes(st);
                const results = [];

                // å¸Œæœ›äººæ•°ãŒ0ã¾ãŸã¯ç„¡åŠ¹ãªå ´åˆã¯æ¤œç´¢ã—ãªã„
                if(requestedPeople <= 0) {
                    renderCards([], requestedPeople);
                    return;
                }

                studios.forEach(studio=>{
                    (studio.rooms || []).forEach(room=>{
                        (room.rates || []).forEach(rate=>{
                            const s = toMinutes(rate.start_time);
                            const e = toMinutes(rate.end_time);
                            
                            // æ¤œç´¢æ¡ä»¶ãƒã‚§ãƒƒã‚¯
                            if(tmin === null) return;
                            if(!(s <= tmin && tmin < e)) return;
                            if(rate.min_price != null && rate.min_price > maxPrice) return;
                            
                            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°: æ¨å¥¨æœ€å¤§äººæ•°ãŒã€å¸Œæœ›äººæ•°ä»¥ä¸Šã§ã‚ã‚‹ã“ã¨
                            if(room.recommended_max != null && room.recommended_max < requestedPeople) return; 
                            
                            // ğŸ’¡ Cost Per Person ã®è¨ˆç®— (å¸Œæœ›äººæ•°ã§å‰²ã‚‹)
                            const isCalculable = rate.min_price != null && requestedPeople > 0;
                            const cost_per_person = isCalculable ? rate.min_price / requestedPeople : null; 
                            
                            results.push({
                                studio_name: studio.studio_name,
                                studio_url: studio.official_url,
                                room_name: room.room_name,
                                room: room,
                                rate: rate,
                                cost_per_person: cost_per_person
                            });
                        });
                    });
                });

                // ã‚³ã‚¹ãƒˆ per person ã§ã‚½ãƒ¼ãƒˆï¼ˆnullã¯æœ€å¾Œã«å›ã‚‹ï¼‰
                results.sort((a,b)=>(a.cost_per_person ?? Infinity) - (b.cost_per_person ?? Infinity));
                renderCards(results, requestedPeople); // ğŸ’¡ å¸Œæœ›äººæ•°ã‚’æ¸¡ã™
            }

            searchBtn.addEventListener('click', search);
            [timeInput, priceInput, peopleInput].forEach(inp=>{
                inp.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') search(); });
            });
            // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å¾Œã«åˆæœŸæ¤œç´¢ã‚’å®Ÿè¡Œ
            search();
        }


        // ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼šä¾¡æ ¼ã‹ã‚‰ã€Œå††ã€ã¨æ—¥ä»˜ã‚’å‰Šé™¤ã—ã€ã‚¯ãƒªãƒ¼ãƒ³ãªãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™é–¢æ•°
        function cleanRateData(r) {
            let price = (r.min_price || '').toString().replace(/[^\d.]/g, '');
            price = price ? Number(price) : null;
            
            const startTimeMatch = (r.start_time || '').match(/(\d{2}:\d{2})$/);
            const endTimeMatch = (r.end_time || '').match(/(\d{2}:\d{2})$/);

            return {
                rate_name: (r.rate_name||'').trim(),
                start_time: startTimeMatch ? startTimeMatch[1] : (r.start_time||'').trim(), 
                end_time: endTimeMatch ? endTimeMatch[1] : (r.end_time||'').trim(),
                min_price: price 
            };
        }

        // CSV/JSONå…±é€šã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯
        function processFetchedData(rows) {
            const studiosMap = {};
            rows.forEach(r=>{
                 const sid = (r.studio_id || r.studio_name || '').toString().trim();
                 if(!sid) return;

                 if(!studiosMap[sid]) {
                     studiosMap[sid] = { 
                         id: sid, 
                         studio_name: (r.studio_name||'').trim(), 
                         official_url: (r.official_url||'').trim(), 
                         rooms: {} 
                     };
                 }
                 const s = studiosMap[sid];

                 const rid = (r.room_id || r.room_name || '').toString().trim();
                 if(!rid) return;
                 
                 if(!s.rooms[rid]) {
                     s.rooms[rid] = { 
                         id: rid, 
                         room_name: (r.room_name||'').trim(), 
                         recommended_max: r.recommended_max ? Number(r.recommended_max) : null, 
                         rates: [] 
                     };
                 }
                 
                 const rate = cleanRateData(r);

                 if(rate.rate_name && rate.start_time && rate.min_price !== null) {
                      s.rooms[rid].rates.push(rate);
                 }
            });

            return Object.values(studiosMap).map(s=>({ id: s.id, studio_name: s.studio_name, official_url: s.official_url, rooms: Object.values(s.rooms) }));
        }

        // CSV/JSONãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°ï¼ˆå¤‰æ›´ãªã—ï¼‰
        async function fetchCsvToStudios(url){ /* ... */ }
        async function fetchLocalJson(){ 
            const res = await fetch('data.json');
            if(!res.ok) throw new Error('data.json fetch failed: '+res.status + ' - JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ãƒ‘ã‚¹ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚');
            const data = await res.json();
            return processFetchedData(data);
        }


        // ==========================================================
        // ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼šéåŒæœŸã®åˆæœŸåŒ–é–¢æ•°ã«ãƒ©ãƒƒãƒ—ã—ã€å®Ÿè¡Œã™ã‚‹ 
        // ==========================================================
        async function initializeApp(){
            try{
                let studios;
                
                // åˆæœŸå€¤è¨­å®š 
                if (!timeInput.value) { timeInput.value = '18:00'; }
                if (!priceInput.value) { priceInput.value = '5000'; }
                if (!peopleInput.value) { peopleInput.value = '5'; }
                
                if(AIRTABLE_CSV_URL && AIRTABLE_CSV_URL.trim() !== ''){
                    console.log('Airtable CSVã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’é–‹å§‹ã—ã¾ã™...');
                    studios = await fetchCsvToStudios(AIRTABLE_CSV_URL);
                    
                } else {
                    console.log('AIRTABLE_CSV_URLãŒæœªè¨­å®šã®ãŸã‚ã€data.jsonã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚');
                    studios = await fetchLocalJson();
                }
                
                console.log('--- èª­ã¿è¾¼ã¾ã‚ŒãŸæœ€çµ‚ãƒ‡ãƒ¼ã‚¿ ---');
                console.log(studios); 
                
                runSearch(studios);
                
            }catch(err){
                console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', err);
                result.innerHTML = '<p style="color:red;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ« (F12) ã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>